openapi: 3.0.3
info:
  title: Billing Service API
  description: |
    Микросервис для управления платежами в системе каршеринга.
    Предоставляет функциональность создания платежей, генерации QR-кодов для оплаты
    и управления статусами платежей.
  version: 1.0.0
  contact:
    name: API Support
    email: support@zdrive.example

servers:
  - url: http://localhost:3004
    description: Локальный сервер разработки
  - url: http://api.zdrive.example
    description: Продакшн сервер

tags:
  - name: payments
    description: Операции с платежами

paths:
  /payments:
    post:
      tags:
        - payments
      summary: Создать платеж
      description: |
        Создает новый платеж для поездки и генерирует QR-код для оплаты.
        QR-код возвращается в ответе и может быть отображен на фронтенде.
      operationId: createPayment
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreatePaymentRequest'
            example:
              trip_id: "770e8400-e29b-41d4-a716-446655440002"
              user_id: "550e8400-e29b-41d4-a716-446655440000"
              amount: 150.50
      responses:
        '200':
          description: Платеж успешно создан
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreatePaymentResponse'
              example:
                payment_id: "880e8400-e29b-41d4-a716-446655440003"
                qr_code_url: "https://www.youtube.com/watch?v=dQw4w9WgXcQ&payment_id=880e8400-e29b-41d4-a716-446655440003"
        '400':
          description: Неверная сумма платежа
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "Invalid payment amount: -10.0"
        '409':
          description: Платеж уже существует для этой поездки
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "Payment already exists for this trip"
        '500':
          description: Внутренняя ошибка сервера
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /payments/{id}:
    get:
      tags:
        - payments
      summary: Получить платеж
      description: Возвращает информацию о платеже по его ID
      operationId: getPayment
      parameters:
        - name: id
          in: path
          required: true
          description: UUID платежа
          schema:
            type: string
            format: uuid
          example: "880e8400-e29b-41d4-a716-446655440003"
      responses:
        '200':
          description: Данные платежа
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaymentResponse'
              example:
                id: "880e8400-e29b-41d4-a716-446655440003"
                trip_id: "770e8400-e29b-41d4-a716-446655440002"
                user_id: "550e8400-e29b-41d4-a716-446655440000"
                amount: 150.50
                status: "pending"
                bank_reference: null
                qr_code_url: "https://www.youtube.com/watch?v=dQw4w9WgXcQ&payment_id=880e8400-e29b-41d4-a716-446655440003"
                created_at: "2024-01-15T10:30:00Z"
                paid_at: null
        '404':
          description: Платеж не найден
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Внутренняя ошибка сервера
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /users/{user_id}/payments:
    get:
      tags:
        - payments
      summary: Получить все платежи пользователя
      description: Возвращает список всех платежей указанного пользователя
      operationId: getUserPayments
      parameters:
        - name: user_id
          in: path
          required: true
          description: UUID пользователя
          schema:
            type: string
            format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
      responses:
        '200':
          description: Список платежей пользователя
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/PaymentResponse'
              example:
                - id: "880e8400-e29b-41d4-a716-446655440003"
                  trip_id: "770e8400-e29b-41d4-a716-446655440002"
                  user_id: "550e8400-e29b-41d4-a716-446655440000"
                  amount: 150.50
                  status: "paid"
                  bank_reference: "REF123456"
                  qr_code_url: "https://www.youtube.com/watch?v=dQw4w9WgXcQ&payment_id=880e8400-e29b-41d4-a716-446655440003"
                  created_at: "2024-01-15T10:30:00Z"
                  paid_at: "2024-01-15T10:35:00Z"
        '500':
          description: Внутренняя ошибка сервера
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  schemas:
    CreatePaymentRequest:
      type: object
      required:
        - trip_id
        - user_id
        - amount
      properties:
        trip_id:
          type: string
          format: uuid
          description: UUID поездки из trips сервиса
          example: "770e8400-e29b-41d4-a716-446655440002"
        user_id:
          type: string
          format: uuid
          description: UUID пользователя из users сервиса
          example: "550e8400-e29b-41d4-a716-446655440000"
        amount:
          type: number
          format: double
          minimum: 0
          exclusiveMinimum: true
          description: Сумма платежа (должна быть больше 0)
          example: 150.50

    CreatePaymentResponse:
      type: object
      properties:
        payment_id:
          type: string
          format: uuid
          description: UUID созданного платежа
          example: "880e8400-e29b-41d4-a716-446655440003"
        qr_code_url:
          type: string
          format: uri
          description: URL QR-кода для оплаты (в MVP - мок с рикроллом)
          example: "https://www.youtube.com/watch?v=dQw4w9WgXcQ&payment_id=880e8400-e29b-41d4-a716-446655440003"

    PaymentResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
          description: UUID платежа
          example: "880e8400-e29b-41d4-a716-446655440003"
        trip_id:
          type: string
          format: uuid
          description: UUID поездки
          example: "770e8400-e29b-41d4-a716-446655440002"
        user_id:
          type: string
          format: uuid
          description: UUID пользователя
          example: "550e8400-e29b-41d4-a716-446655440000"
        amount:
          type: number
          format: double
          description: Сумма платежа
          example: 150.50
        status:
          type: string
          enum: [pending, paid, failed, cancelled]
          description: Статус платежа
          example: "pending"
        bank_reference:
          type: string
          nullable: true
          description: Референс банка (заполняется после успешной оплаты)
          example: "REF123456"
        qr_code_url:
          type: string
          format: uri
          nullable: true
          description: URL QR-кода для оплаты
          example: "https://www.youtube.com/watch?v=dQw4w9WgXcQ&payment_id=880e8400-e29b-41d4-a716-446655440003"
        created_at:
          type: string
          format: date-time
          description: Время создания платежа
          example: "2024-01-15T10:30:00Z"
        paid_at:
          type: string
          format: date-time
          nullable: true
          description: Время оплаты (заполняется после успешной оплаты)
          example: "2024-01-15T10:35:00Z"

    ErrorResponse:
      type: object
      properties:
        error:
          type: string
          description: Описание ошибки
          example: "Payment not found"

