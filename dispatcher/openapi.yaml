openapi: 3.0.3
info:
  title: Dispatcher API (API Gateway)
  description: |
    API Gateway для каршеринга. Объединяет все микросервисы и предоставляет единую точку входа для клиентского и админского фронтендов.
  version: 1.0.0
  contact:
    name: Car Sharing API Support

servers:
  - url: http://localhost:8080
    description: Local development server
  - url: https://api.carsharing.example.com
    description: Production server

tags:
  - name: auth
    description: Аутентификация и регистрация пользователей
  - name: trips
    description: Управление поездками (клиент)
  - name: cars
    description: Информация о машинах (клиент)
  - name: admin
    description: Административные функции

paths:
  # Client endpoints
  /auth/register:
    post:
      tags:
        - auth
      summary: Регистрация нового пользователя
      description: Регистрирует нового пользователя в системе
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
            example:
              license_id: "AB123456"
              driving_experience: 5
              rating: 4.5
              email: "user@example.com"
              password: "securepassword123"
      responses:
        '200':
          description: Пользователь успешно зарегистрирован
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RegisterResponse'
        '400':
          description: Неверный запрос
        '502':
          description: Сервис недоступен

  /auth/authenticate:
    post:
      tags:
        - auth
      summary: Аутентификация пользователя
      description: Аутентифицирует пользователя и возвращает JWT токен
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AuthRequest'
            example:
              email: "user@example.com"
              password: "securepassword123"
      responses:
        '200':
          description: Успешная аутентификация
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '401':
          description: Неверные учетные данные
        '502':
          description: Сервис недоступен

  /trips/start:
    post:
      tags:
        - trips
      summary: Начать поездку
      description: Создает новую поездку (резервирует машину)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/StartTripRequest'
            example:
              user_id: "550e8400-e29b-41d4-a716-446655440000"
              car_id: "660e8400-e29b-41d4-a716-446655440000"
      responses:
        '200':
          description: Поездка успешно создана
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StartTripResponse'
        '400':
          description: Неверный запрос
        '502':
          description: Сервис недоступен

  /trips/end:
    put:
      tags:
        - trips
      summary: Завершить поездку
      description: Завершает поездку и создает платеж
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EndTripRequest'
            example:
              trip_id: "770e8400-e29b-41d4-a716-446655440000"
      responses:
        '200':
          description: Поездка успешно завершена
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EndTripResponse'
        '400':
          description: Неверный запрос
        '502':
          description: Сервис недоступен

  /trips/cancel:
    put:
      tags:
        - trips
      summary: Отменить поездку
      description: Отменяет активную поездку
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CancelTripRequest'
            example:
              trip_id: "770e8400-e29b-41d4-a716-446655440000"
      responses:
        '200':
          description: Поездка успешно отменена
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CancelTripResponse'
        '400':
          description: Неверный запрос
        '502':
          description: Сервис недоступен

  /cars/{car_id}/data:
    get:
      tags:
        - cars
      summary: Получить данные о машине
      description: Возвращает информацию о машине и телематические данные (топливо, местоположение, статус)
      parameters:
        - name: car_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: ID машины
      responses:
        '200':
          description: Данные о машине
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CarDataResponse'
        '404':
          description: Машина не найдена
        '502':
          description: Сервис недоступен

  # Admin endpoints
  /admin/users:
    get:
      tags:
        - admin
      summary: Получить всех пользователей
      description: Возвращает список всех пользователей (только для админов)
      responses:
        '200':
          description: Список пользователей
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/UserInfo'
        '502':
          description: Сервис недоступен

  /admin/users/{id}:
    get:
      tags:
        - admin
      summary: Получить пользователя по ID
      description: Возвращает информацию о конкретном пользователе
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: ID пользователя
      responses:
        '200':
          description: Информация о пользователе
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserInfo'
        '404':
          description: Пользователь не найден
        '502':
          description: Сервис недоступен

  /admin/cars:
    get:
      tags:
        - admin
      summary: Получить все машины
      description: Возвращает список всех машин (только для админов)
      responses:
        '200':
          description: Список машин
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/CarInfo'
        '502':
          description: Сервис недоступен

  /admin/cars/{id}:
    get:
      tags:
        - admin
      summary: Получить машину по ID
      description: Возвращает информацию о конкретной машине
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: ID машины
      responses:
        '200':
          description: Информация о машине
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CarInfo'
        '404':
          description: Машина не найдена
        '502':
          description: Сервис недоступен

  /admin/trips:
    get:
      tags:
        - admin
      summary: Получить все поездки
      description: Возвращает список всех поездок (только для админов)
      responses:
        '200':
          description: Список поездок
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/TripInfo'
        '502':
          description: Сервис недоступен

  /admin/trips/{id}:
    get:
      tags:
        - admin
      summary: Получить поездку по ID
      description: Возвращает информацию о конкретной поездке
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: ID поездки
      responses:
        '200':
          description: Информация о поездке
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TripInfo'
        '404':
          description: Поездка не найдена
        '502':
          description: Сервис недоступен

  /admin/commands:
    post:
      tags:
        - admin
      summary: Отправить команду на машину
      description: Отправляет команду IoT устройству на машине (открыть/закрыть двери, запустить/остановить двигатель)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SendCommandRequest'
            example:
              car_id: "660e8400-e29b-41d4-a716-446655440000"
              command_type: "open_door"
      responses:
        '200':
          description: Команда успешно отправлена
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SendCommandResponse'
        '400':
          description: Неверный запрос
        '502':
          description: Сервис недоступен

components:
  schemas:
    RegisterRequest:
      type: object
      required:
        - license_id
        - driving_experience
        - rating
        - email
        - password
      properties:
        license_id:
          type: string
          description: Номер водительского удостоверения
        driving_experience:
          type: integer
          minimum: 0
          description: Опыт вождения в годах
        rating:
          type: number
          format: float
          minimum: 0
          maximum: 5
          description: Рейтинг пользователя
        email:
          type: string
          format: email
          description: Email пользователя
        password:
          type: string
          format: password
          description: Пароль пользователя

    RegisterResponse:
      type: object
      properties:
        user_id:
          type: string
          format: uuid
          description: ID созданного пользователя

    AuthRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          format: password

    AuthResponse:
      type: object
      properties:
        token:
          type: string
          description: JWT токен для аутентификации
        user_id:
          type: string
          format: uuid

    StartTripRequest:
      type: object
      required:
        - user_id
        - car_id
      properties:
        user_id:
          type: string
          format: uuid
        car_id:
          type: string
          format: uuid

    StartTripResponse:
      type: object
      properties:
        trip_id:
          type: string
          format: uuid

    EndTripRequest:
      type: object
      required:
        - trip_id
      properties:
        trip_id:
          type: string
          format: uuid

    EndTripResponse:
      type: object
      properties:
        trip_id:
          type: string
          format: uuid
        payment_id:
          type: string
          format: uuid
        qr_code_url:
          type: string
          format: uri
          description: URL QR-кода для оплаты

    CancelTripRequest:
      type: object
      required:
        - trip_id
      properties:
        trip_id:
          type: string
          format: uuid

    CancelTripResponse:
      type: object
      properties:
        trip_id:
          type: string
          format: uuid
        message:
          type: string

    CarDataResponse:
      type: object
      properties:
        car:
          $ref: '#/components/schemas/CarInfo'
        telematics:
          type: object
          nullable: true
          properties:
            fuel_level:
              type: number
              format: float
              description: Уровень топлива (0-100)
            location:
              $ref: '#/components/schemas/LocationInfo'
            door_status:
              type: string
              enum: [open, closed]
            speed:
              type: number
              format: float
              description: Скорость в км/ч
            temperature:
              type: number
              format: float
              description: Температура окружающей среды в градусах Цельсия
            timestamp:
              type: string
              format: date-time

    UserInfo:
      type: object
      properties:
        id:
          type: string
          format: uuid
        license_id:
          type: string
        driving_experience:
          type: integer
        rating:
          type: number
          format: float
        email:
          type: string
          format: email

    CarInfo:
      type: object
      properties:
        id:
          type: string
          format: uuid
        model:
          type: string
        license_plate:
          type: string
        state:
          type: string
          enum: [available, in_use, maintenance]
        tariff_id:
          type: string
          format: uuid
        base_price:
          type: number
          format: float

    TripInfo:
      type: object
      properties:
        id:
          type: string
          format: uuid
        user_id:
          type: string
          format: uuid
        car_id:
          type: string
          format: uuid
        status:
          type: string
          enum: [reserved, active, completed, cancelled]
        started_at:
          type: string
          format: date-time
          nullable: true
        ended_at:
          type: string
          format: date-time
          nullable: true
        created_at:
          type: string
          format: date-time

    LocationInfo:
      type: object
      properties:
        latitude:
          type: number
          format: float
        longitude:
          type: number
          format: float

    SendCommandRequest:
      type: object
      required:
        - car_id
        - command_type
      properties:
        car_id:
          type: string
          format: uuid
        command_type:
          type: string
          enum: [open_door, close_door, start_engine, stop_engine]

    SendCommandResponse:
      type: object
      properties:
        command_id:
          type: string
          format: uuid

